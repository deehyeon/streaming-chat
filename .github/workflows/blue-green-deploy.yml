name: Blue-Green Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      target_server:
        description: 'Target server (blue/green)'
        required: true
        default: 'green'
        type: choice
        options:
          - blue
          - green

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/munglog-backend

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x ./munglog-backend/gradlew
        working-directory: .
      
      - name: Build with Gradle
        run: ./gradlew clean build -x test
        working-directory: ./munglog-backend
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./munglog-backend
          file: ./munglog-backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy-green:
    name: Deploy to Green Server
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event.inputs.target_server == 'green'
    
    steps:
      - name: Deploy to Green Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GREEN_SERVER_HOST }}
          username: ${{ secrets.GREEN_SERVER_USER }}
          key: ${{ secrets.GREEN_SERVER_SSH_KEY }}
          script: |
            cd ~/app/green
            
            # Pull latest image
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose pull app
            
            # Restart containers
            docker compose down
            docker compose up -d
            
            # Wait for health check
            echo "Waiting for application to be healthy..."
            for i in {1..30}; do
              if curl -f http://localhost/actuator/health\; then
                echo "✅ Green server is healthy!"
                exit 0
              fi
              echo "Waiting... ($i/30)"
              sleep 10
            done
            
            echo "❌ Health check failed!"
            exit 1
      
      - name: Health Check Result
        run: |
          echo "Green server deployment completed"
          echo "Next: Manually switch traffic in Oracle Load Balancer"
          echo "Or use the switch-traffic job"

  switch-traffic:
    name: Switch Traffic to Green
    runs-on: ubuntu-latest
    needs: deploy-green
    if: github.event_name == 'push'
    
    steps:
      - name: Switch Load Balancer Traffic
        run: |
          echo "⚠️ Manual action required:"
          echo "1. Go to Oracle Cloud Console"
          echo "2. Navigate to Load Balancers → munglog-lb"
          echo "3. Backend Sets → munglog-backend-set"
          echo "4. Update weights:"
          echo "   - Green (10.0.0.11:80): 0 → 1"
          echo "   - Blue (10.0.0.10:80): 1 → 0"
          echo ""
          echo "Or use Oracle CLI (advanced):"
          echo "oci lb backend update --load-balancer-id ${{ secrets.ORACLE_LOAD_BALANCER_OCID }} \\"
          echo "  --backend-set-name ${{ secrets.ORACLE_BACKEND_SET_NAME }} \\"
          echo "  --backend-name ${{ secrets.ORACLE_GREEN_BACKEND_NAME }} \\"
          echo "  --weight 1"

  deploy-blue:
    name: Deploy to Blue Server
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.target_server == 'blue'
    
    steps:
      - name: Deploy to Blue Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.BLUE_SERVER_HOST }}
          username: ${{ secrets.BLUE_SERVER_USER }}
          key: ${{ secrets.BLUE_SERVER_SSH_KEY }}
          script: |
            cd ~/app/blue
            
            # Pull latest image
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker compose pull app
            
            # Restart containers
            docker compose down
            docker compose up -d
            
            # Wait for health check
            echo "Waiting for application to be healthy..."
            for i in {1..30}; do
              if curl -f http://localhost/actuator/health\; then
                echo "✅ Blue server is healthy!"
                exit 0
              fi
              echo "Waiting... ($i/30)"
              sleep 10
            done
            
            echo "❌ Health check failed!"
            exit 1
