name: Backend Blue-Green Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'munglog-backend/**'
      - '.github/workflows/backend-deploy.yml'
  
  workflow_dispatch:
    inputs:
      target_server:
        description: 'Target server for deployment'
        required: true
        default: 'green'
        type: choice
        options:
          - blue
          - green

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/munglog-backend

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        working-directory: ./munglog-backend
      
      - name: Build with Gradle
        run: ./gradlew clean build -x test --parallel --no-daemon
        working-directory: ./munglog-backend
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./munglog-backend
          file: ./munglog-backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
      
      - name: Image digest
        run: |
          echo "### ðŸ³ Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.meta.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY

  deploy-green:
    name: Deploy to Green Server
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' || github.event.inputs.target_server == 'green'
    
    steps:
      - name: Deploy to Green Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_HOST_PORT: ${{ secrets.POSTGRES_HOST_PORT }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          BASE_URL: ${{ secrets.BASE_URL }}
        with:
          host: ${{ secrets.GREEN_SERVER_HOST }}
          username: ${{ secrets.GREEN_SERVER_USER }}
          key: ${{ secrets.GREEN_SERVER_SSH_KEY }}
          envs: POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_HOST_PORT,REDIS_PORT,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,BASE_URL
          script: |
            set -e
            
            cd ~/app/green
            
            echo "=== Updating .env file ==="
            cat > .env << ENVEOF
            POSTGRES_DB=${POSTGRES_DB}
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_HOST_PORT=${POSTGRES_HOST_PORT}
            REDIS_PORT=${REDIS_PORT}
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            BASE_URL=${BASE_URL}
            ENVEOF
            
            chmod 600 .env
            
            echo "=== Logging in to GitHub Container Registry ==="
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "=== Pulling latest image ==="
            docker compose pull app
            
            echo "=== Stopping old containers ==="
            docker compose down
            
            echo "=== Starting new containers ==="
            docker compose up -d
            
            echo "=== Waiting for application to start (45s) ==="
            sleep 45
            
            echo "=== Health check ==="
            for i in {1..20}; do
              HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/actuator/health)
              
              if [ "$HEALTH" -eq 200 ]; then
                echo "âœ… Green server is healthy! (HTTP $HEALTH)"
                echo ""
                echo "=== Container Status ==="
                docker compose ps
                echo ""
                echo "=== Recent Logs ==="
                docker compose logs --tail=30 app
                exit 0
              fi
              
              echo "â³ Health check attempt $i/20 - HTTP: $HEALTH"
              sleep 10
            done
            
            echo "âŒ Health check failed after 200 seconds!"
            echo ""
            echo "=== Container Status ==="
            docker compose ps
            echo ""
            echo "=== Full Logs ==="
            docker compose logs app
            exit 1
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "### âœ… Green Server Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.GREEN_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Test: \`curl http://${{ secrets.GREEN_SERVER_HOST }}/actuator/health\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Switch traffic in Oracle Load Balancer" >> $GITHUB_STEP_SUMMARY
          echo "   - Green (10.0.1.166:80): Weight 0 â†’ 1" >> $GITHUB_STEP_SUMMARY
          echo "   - Blue (10.0.1.79:80): Weight 1 â†’ 0" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor for 5-10 minutes" >> $GITHUB_STEP_SUMMARY
          echo "4. Deactivate Blue if stable" >> $GITHUB_STEP_SUMMARY

  deploy-blue:
    name: Deploy to Blue Server
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.target_server == 'blue'
    
    steps:
      - name: Deploy to Blue Server
        uses: appleboy/ssh-action@v1.0.3
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          POSTGRES_HOST_PORT: ${{ secrets.POSTGRES_HOST_PORT }}
          REDIS_PORT: ${{ secrets.REDIS_PORT }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          BASE_URL: ${{ secrets.BASE_URL }}
        with:
          host: ${{ secrets.BLUE_SERVER_HOST }}
          username: ${{ secrets.BLUE_SERVER_USER }}
          key: ${{ secrets.BLUE_SERVER_SSH_KEY }}
          envs: POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,POSTGRES_HOST_PORT,REDIS_PORT,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,BASE_URL
          script: |
            set -e
            
            cd ~/app/blue
            
            echo "=== Updating .env file ==="
            cat > .env << ENVEOF
            POSTGRES_DB=${POSTGRES_DB}
            POSTGRES_USER=${POSTGRES_USER}
            POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            POSTGRES_HOST_PORT=${POSTGRES_HOST_PORT}
            REDIS_PORT=${REDIS_PORT}
            GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
            BASE_URL=${BASE_URL}
            ENVEOF
            
            chmod 600 .env
            
            echo "=== Logging in to GHCR ==="
            echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            echo "=== Pulling latest image ==="
            docker compose pull app
            
            echo "=== Restarting containers ==="
            docker compose down
            docker compose up -d
            
            sleep 45
            
            echo "=== Health check ==="
            for i in {1..20}; do
              HEALTH=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/actuator/health)
              
              if [ "$HEALTH" -eq 200 ]; then
                echo "âœ… Blue server is healthy!"
                docker compose ps
                exit 0
              fi
              
              echo "â³ Attempt $i/20 - HTTP: $HEALTH"
              sleep 10
            done
            
            echo "âŒ Health check failed!"
            docker compose logs app
            exit 1
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "### âœ… Blue Server Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.BLUE_SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
