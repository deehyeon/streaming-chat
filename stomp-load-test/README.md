# STOMP Load Testing Tool ğŸš€

ê³ ì„±ëŠ¥ Go ê¸°ë°˜ STOMP í”„ë¡œí† ì½œ ë¶€í•˜ í…ŒìŠ¤íŠ¸ ë„êµ¬ + Prometheus & Grafana ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§

## âœ¨ ì£¼ìš” íŠ¹ì§•

- ğŸ”¥ **10,000+ ë™ì‹œ ì ‘ì† ì§€ì›**: ê³ ë£¨í‹´ ê¸°ë°˜ ê²½ëŸ‰ ì•„í‚¤í…ì²˜
- ğŸ“Š **ìƒì„¸í•œ í†µê³„**: í‰ê· /ì¤‘ì•™ê°’/ë°±ë¶„ìœ„(P90/P95/P99) ì œê³µ
- ğŸ¯ **ì •í™•í•œ ì¸¡ì •**: Race Condition í•´ê²°ëœ ì•ˆì „í•œ ë°ì´í„° ìˆ˜ì§‘
- ğŸ“ˆ **ë‹¨ê³„ë³„ ë¶€í•˜ ì¦ê°€**: Stage ê¸°ë°˜ ì ì§„ì  ë¶€í•˜ í…ŒìŠ¤íŠ¸
- ğŸ’¾ **CSV ê²°ê³¼ ì €ì¥**: ìë™ìœ¼ë¡œ ê²°ê³¼ë¥¼ CSV íŒŒì¼ë¡œ ì €ì¥
- ğŸ¨ **ì‹¤ì‹œê°„ ì§„í–‰ë¥ **: ì»¬ëŸ¬í’€í•œ ì½˜ì†” ì¶œë ¥
- ğŸ“‰ **Prometheus & Grafana**: ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì‹œê°í™”

## ğŸ—ï¸ ì•„í‚¤í…ì²˜

### JMeter vs Go ë¹„êµ

| í•­ëª© | JMeter (OS Thread) | Go (Goroutine) |
|------|-------------------|----------------|
| ë©”ëª¨ë¦¬ ì‚¬ìš© (10,000ëª…) | ~10GB | ~20MB |
| ìŠ¤ë ˆë“œ ì˜¤ë²„í—¤ë“œ | 1-2MB/ìŠ¤ë ˆë“œ | 2KB/ê³ ë£¨í‹´ |
| ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ | OS ë ˆë²¨ (ëŠë¦¼) | Go ëŸ°íƒ€ì„ (ë¹ ë¦„) |
| í™•ì¥ì„± | ë¶„ì‚° í…ŒìŠ¤íŠ¸ í•„ìš” | ë‹¨ì¼ ë¨¸ì‹ ìœ¼ë¡œ ì¶©ë¶„ |

### ê³ ë£¨í‹´ì˜ ì¥ì 

```
10,000ê°œ ê³ ë£¨í‹´ (ê° 2KB)
        â†“
  Go ëŸ°íƒ€ì„ ìŠ¤ì¼€ì¤„ëŸ¬
        â†“
8ê°œ OS ìŠ¤ë ˆë“œ (CPU ì½”ì–´ ìˆ˜)
```

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### 1. ì˜ì¡´ì„± ì„¤ì¹˜

```bash
cd stomp-load-test
go mod download
```

### 2. ì„¤ì • ë³€ê²½

`main.go` íŒŒì¼ì—ì„œ ë‹¤ìŒ ê°’ë“¤ì„ ìˆ˜ì •í•˜ì„¸ìš”:

```go
var (
    token = "your-jwt-token-here"  // JWT í† í°
    url   = "your-server:port"     // ì„œë²„ ì£¼ì†Œ
)

// ìŠ¤í…Œì´ì§€ ì„¤ì •
var stages = []Stage{
    {300, "ì´ˆê¸° ë¶€í•˜", 10},   // 300ëª…, 10ì´ˆì— ê±¸ì³
    {300, "í”¼í¬ ë¶€í•˜", 10},   // ì¶”ê°€ 300ëª…, 10ì´ˆì— ê±¸ì³
    {300, "ìµœì¢… ë¶€í•˜", 10},   // ì¶”ê°€ 300ëª…, 10ì´ˆì— ê±¸ì³
}
```

### 3. Prometheus & Grafana ì‹œì‘ (ì„ íƒì‚¬í•­)

```bash
docker-compose up -d
```

- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin)

### 4. í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
go run main.go
```

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­

í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘ ë‹¤ìŒ ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ë©”íŠ¸ë¦­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:
- **Prometheus Metrics**: http://localhost:2112/metrics
- **Grafana Dashboard**: http://localhost:3000

### ëŒ€ì‹œë³´ë“œ ê¸°ëŠ¥

- ğŸ“ˆ í™œì„± ì—°ê²° ìˆ˜ ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§
- â±ï¸ ë©”ì‹œì§€ ì§€ì—°ì‹œê°„ ë°±ë¶„ìœ„ (P50/P90/P95/P99)
- ğŸš€ ì´ˆë‹¹ ì²˜ë¦¬ëŸ‰ (messages/sec)
- ğŸ”Œ WebSocket/STOMP ì—°ê²° ì‹œê°„
- âš ï¸ ì„±ê³µ/ì—ëŸ¬ ë¹„ìœ¨
- ğŸ“Š ëˆ„ì  í†µê³„

ìì„¸í•œ ë‚´ìš©ì€ [MONITORING.md](./MONITORING.md)ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

## ğŸ“Š ê²°ê³¼ í•´ì„

### ì½˜ì†” ì¶œë ¥ ì˜ˆì‹œ

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ì „ì²´ í…ŒìŠ¤íŠ¸ ê²°ê³¼ í†µê³„
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š í…ŒìŠ¤íŠ¸ ìš”ì•½
  ì´ ì›Œì»¤ ìˆ˜: 900
  í…ŒìŠ¤íŠ¸ ì‹œê°„: 45.234s
  ì„±ê³µë¥ : 98.67% (888/900)

ğŸ“¨ ë©”ì‹œì§€ í†µê³„
  ì „ì†¡: 888
  ìˆ˜ì‹ : 888
  ì˜¤ë¥˜: 12

âš¡ ì„±ëŠ¥ ë©”íŠ¸ë¦­

  ë©”ì‹œì§€ ì§€ì—° ì‹œê°„
  Avg: 45.23ms, Min: 12.34ms, Max: 234.56ms, 
  Med: 42.11ms, P90: 78.90ms, P95: 98.76ms, P99: 187.65ms

  WebSocket ì—°ê²° ì‹œê°„
  Avg: 123.45ms, Min: 89.12ms, Max: 456.78ms, 
  Med: 115.23ms, P90: 234.56ms, P95: 289.01ms, P99: 398.76ms
```

### CSV ì¶œë ¥

`load_test_result.csv` íŒŒì¼ì´ ìë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤:

```csv
Metric,Value,Unit
total_workers,900,
success_rate,98.67,
message_latency_avg,45.23,
message_latency_p95,98.76,
...
```

## ğŸ”§ ì»¤ìŠ¤í„°ë§ˆì´ì§•

### êµ¬ë… ê²½ë¡œ ë³€ê²½

```go
// main.go - worker í•¨ìˆ˜ ë‚´
subscribeFrame := "SUBSCRIBE\nid:sub-1\ndestination:/your/subscription/path\n\n\u0000"
```

### ë©”ì‹œì§€ ë°œí–‰ ê²½ë¡œ ë³€ê²½

```go
// main.go - worker í•¨ìˆ˜ ë‚´
sendFrame := fmt.Sprintf("SEND\ndestination:/your/publish/path\n\n{\"message\":\"%s\"}\u0000", message)
```

### íƒ€ì„ì•„ì›ƒ ì„¤ì •

```go
// WebSocket ì—°ê²° íƒ€ì„ì•„ì›ƒ
dialer := websocket.Dialer{
    HandshakeTimeout: 30 * time.Second,  // ë³€ê²½ ê°€ëŠ¥
}

// ë©”ì‹œì§€ ìˆ˜ì‹  íƒ€ì„ì•„ì›ƒ
timeout := time.After(30 * time.Second)  // ë³€ê²½ ê°€ëŠ¥
```

### Prometheus ë©”íŠ¸ë¦­ í¬íŠ¸ ë³€ê²½

```go
// main.go
startMetricsServer("2112")  // ë‹¤ë¥¸ í¬íŠ¸ë¡œ ë³€ê²½ ê°€ëŠ¥
```

## ğŸ“ˆ ì„±ëŠ¥ ìµœì í™” íŒ

### 1. ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ì œí•œ í•´ì œ

```bash
# Linux/Mac
ulimit -n 65535  # íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ì œí•œ ì¦ê°€
```

### 2. Go ëŸ°íƒ€ì„ íŠœë‹

```bash
# CPU ì½”ì–´ ìˆ˜ ëª…ì‹œ
GOMAXPROCS=16 go run main.go

# GC íŠœë‹
GOGC=50 go run main.go  # GCë¥¼ ë” ìì£¼ ì‹¤í–‰
```

### 3. ë‹¨ê³„ì  ë¶€í•˜ ì¦ê°€

```go
// ê¸‰ê²©í•œ ë¶€í•˜ë³´ë‹¤ëŠ” ì ì§„ì ìœ¼ë¡œ
var stages = []Stage{
    {100, "ì›Œë°ì—…", 10},
    {500, "ì¤‘ê°„ ë¶€í•˜", 20},
    {1000, "ê³ ë¶€í•˜", 30},
    {2000, "í”¼í¬", 40},
}
```

## ğŸ› ë¬¸ì œ í•´ê²°

### "too many open files" ì—ëŸ¬

```bash
ulimit -n 65535
```

### ë©”ëª¨ë¦¬ ë¶€ì¡±

- ìŠ¤í…Œì´ì§€ë‹¹ ì›Œì»¤ ìˆ˜ë¥¼ ì¤„ì´ì„¸ìš”
- í…ŒìŠ¤íŠ¸ durationì„ ëŠ˜ë ¤ì„œ ì²œì²œíˆ ì¦ê°€ì‹œí‚¤ì„¸ìš”

### íƒ€ì„ì•„ì›ƒ ë°œìƒ

- ë„¤íŠ¸ì›Œí¬ ì—°ê²° í™•ì¸
- ì„œë²„ ì„±ëŠ¥ í™•ì¸
- íƒ€ì„ì•„ì›ƒ ê°’ ì¦ê°€

### Prometheus ë©”íŠ¸ë¦­ì´ ìˆ˜ì§‘ë˜ì§€ ì•ŠìŒ

- `http://localhost:2112/metrics` ì ‘ê·¼ í™•ì¸
- `prometheus.yml`ì˜ íƒ€ê²Ÿ ì£¼ì†Œ í™•ì¸
- Docker ë„¤íŠ¸ì›Œí¬ ì„¤ì • í™•ì¸ (host.docker.internal vs 172.17.0.1)

## ğŸ“ ë¡œê·¸

- **ì½˜ì†” ë¡œê·¸**: ì§„í–‰ ìƒí™© ë° ìµœì¢… ê²°ê³¼
- **íŒŒì¼ ë¡œê·¸**: `load_test.log` - ìƒì„¸í•œ ì—ëŸ¬ ë¡œê·¸
- **CSV ê²°ê³¼**: `load_test_result.csv` - í†µê³„ ë°ì´í„°
- **Prometheus**: ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­

## ğŸ” ì£¼ìš” ê°œì„  ì‚¬í•­

### ì›ë³¸ ì½”ë“œ ëŒ€ë¹„ ìˆ˜ì •ì‚¬í•­

1. âœ… **Race Condition í•´ê²°**: `sync.Mutex`ë¡œ ë™ì‹œì„± ì•ˆì „ì„± í™•ë³´
2. âœ… **í†µê³„ í•¨ìˆ˜ ìˆ˜ì •**: ì •ë ¬ í›„ ì •í™•í•œ ì¤‘ì•™ê°’/ë°±ë¶„ìœ„ ê³„ì‚°
3. âœ… **íƒ€ì´ë° ì¸¡ì • ìˆ˜ì •**: `Nanosecond()` â†’ `UnixNano()`
4. âœ… **CSV ì €ì¥ ê¸°ëŠ¥**: ìë™ìœ¼ë¡œ ê²°ê³¼ íŒŒì¼ ìƒì„±
5. âœ… **ì—ëŸ¬ í•¸ë“¤ë§ ê°œì„ **: íƒ€ì„ì•„ì›ƒ ë° ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™”
6. âœ… **ì§„í–‰ë¥  í‘œì‹œ**: ì‹¤ì‹œê°„ í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì¶”ê°€
7. âœ… **P99 ë°±ë¶„ìœ„ ì¶”ê°€**: ë” ìƒì„¸í•œ í†µê³„ ì œê³µ
8. âœ… **Prometheus í†µí•©**: ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
9. âœ… **Grafana ëŒ€ì‹œë³´ë“œ**: ì‚¬ì „ êµ¬ì„±ëœ ì‹œê°í™”

## ğŸ“š ì°¸ê³  ìë£Œ

- [STOMP Protocol Specification](https://stomp.github.io/)
- [Gorilla WebSocket](https://github.com/gorilla/websocket)
- [Go Concurrency Patterns](https://go.dev/blog/pipelines)
- [Prometheus Go Client](https://github.com/prometheus/client_golang)
- [Grafana Dashboards](https://grafana.com/docs/grafana/latest/dashboards/)

## ğŸ“„ ë¼ì´ì„¼ìŠ¤

MIT License

---

**Made with â¤ï¸ for high-performance load testing & monitoring**
